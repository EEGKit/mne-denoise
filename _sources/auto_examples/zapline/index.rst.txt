

.. _sphx_glr_auto_examples_zapline:

ZapLine Examples
================

Examples demonstrating the ZapLine algorithm for power line noise removal.

ZapLine uses DSS (Denoising Source Separation) to find and remove spatial
components that carry power line artifacts (50/60 Hz and harmonics).

References:

- de Cheveigné, A. (2020). ZapLine: A simple and effective method to remove
  power line artifacts. NeuroImage, 207, 116356.
- Klug, M., & Kloosterman, N. A. (2022). Zapline-plus: A Zapline extension for
  automatic and adaptive removal of frequency-specific noise artifacts in M/EEG.
  Human Brain Mapping, 43(12), 3824-3839.


Data Sources from the ZapLine Paper
-----------------------------------

The original ZapLine paper (de Cheveigné, 2020) evaluated the method on three
types of data. Here we document these sources for reproducibility.

**1. Simulated Data (10000×100)**

The paper generates synthetic data with:

- **Signal**: Gaussian random noise (broadband), 10000 samples × 100 channels
- **Line noise**: Sinusoid → half-wave rectified → raised to power 3
- Spatial topography via multiplication by random 1×100 matrix
- Signal and noise scaled to approximately equal power (0 dB SNR)
- **ZapLine d = 1** (single spatial component removed)

Use ``data/simulation.py:generate_zapline_paper_simulation()`` to reproduce.

**2. EEG Data: Di Liberto et al. (2015)**

- **Channels**: 136 (BioSemi)
- **Sampling rate**: 512 Hz
- **ZapLine d = 2**
- **Citation**: Di Liberto, G. M., et al. (2015). Low-frequency cortical
  entrainment to speech reflects phoneme-level processing. Current Biology.

Download options:

- **OpenNeuro**: Dataset ``ds004408`` (EEG responses to continuous naturalistic speech)

  .. code-block:: bash

      # Option 1: OpenNeuro CLI
      pip install openneuro-py
      openneuro download --dataset ds004408 --snapshot 1.0.8 --out ./di_liberto_eeg

      # Option 2: DataLad
      datalad install https://github.com/OpenNeuroDatasets/ds004408.git

**3. MEG Data: Yokogawa System**

- **Channels**: 166
- **Sampling rate**: 200 Hz (downsampled)
- **ZapLine d = 4**
- **Note**: The paper does not identify a public repository for this dataset.
  The NoiseTools example page may contain the specific file.


Additional Data Sources (NoiseTools Examples)
---------------------------------------------

The NoiseTools MATLAB toolbox provides 8 example scripts with various real
datasets. Data download links are embedded in the MATLAB scripts:

http://audition.ens.fr/adc/NoiseTools/src/NoiseTools/EXAMPLES/zapline/

**Example 1: Monkey ECoG (FieldTrip)**

- **Source**: FieldTrip tutorial data
- **Line freq**: 50 Hz, **d = 4**
- **Download**: ``ftp://ftp.fieldtriptoolbox.org/pub/fieldtrip/tutorial/monkey_ecog/data.mat``

**Example 2: Resting EEG (Trujillo et al.)**

- **Citation**: Trujillo et al. (2017). DOI: 10.3389/fnins.2017.00425
- **Channels**: 66, **Line freq**: 60 Hz, **d = 3**
- **Download**: https://doi.org/10.18738/T8/ANS9Q1

**Examples 3-6: NoiseTools MEG/EEG**

- From NoiseTools example data (available via NoiseTools download)
- Various configurations of epoched and continuous data

**Example 7: Saline Phantom EEG**

- EEG from electrodes in saline in glass within shielded booth
- Minimal artifact, minimal removal (demonstration of safety)

**Example 8: High Sample Rate Resting EEG**

- **Source**: DataDryad
- **Download**: https://datadryad.org/resource/doi:10.5061/dryad.v9f16


Quick Start with MNE Sample Data
--------------------------------

For convenience, our examples primarily use:

1. **Synthetic data** (auto-generated, no download needed)
2. **MNE Sample dataset** (auto-downloads via ``mne.datasets.sample.data_path()``)

This ensures all examples work out-of-the-box without manual data setup.

.. code-block:: python

    # Example: Use MNE sample data
    import mne
    data_path = mne.datasets.sample.data_path()
    raw = mne.io.read_raw_fif(data_path / 'MEG/sample/sample_audvis_raw.fif')


Files in This Directory
-----------------------

- ``plot_01_zapline_fundamentals.py``: Basic ZapLine usage on synthetic data
- ``plot_02_zapline_parameters.py``: Parameter tuning and component selection
- ``plot_03_zapline_epochs.py``: Apply ZapLine to epoched MNE data
- ``plot_04_zapline_plus_paper.py``: Zapline-plus adaptive cleaning on non-stationary data
- ``plot_05_zapline_plus_advanced.py``: Advanced features (harmonics, topographies, hybrid fallback)
- ``data/simulation.py``: Paper-faithful simulation generator



.. raw:: html

    <div class="sphx-glr-thumbnails">

.. thumbnail-parent-div-open

.. raw:: html

    <div class="sphx-glr-thumbcontainer" tooltip="This example demonstrates the advanced features of Zapline-plus: 1. Harmonic Processing: Auto-detect and remove harmonics (2f, 3f, ...) 2. Hybrid Fallback: Notch filter cleanup when ZapLine struggles 3. Topography Outputs: Per-chunk spatial patterns of removed artifacts 4. Chunk Metadata: Detailed per-segment cleaning information">

.. only:: html

  .. image:: /auto_examples/zapline/images/thumb/sphx_glr_plot_05_adaptive_advanced_thumb.png
    :alt:

  :doc:`/auto_examples/zapline/plot_05_adaptive_advanced`

.. raw:: html

      <div class="sphx-glr-thumbnail-title">ZapLine-plus: Advanced Settings and Features</div>
    </div>


.. raw:: html

    <div class="sphx-glr-thumbcontainer" tooltip="This tutorial demonstrates ZapLine for removing power line noise (50/60 Hz).">

.. only:: html

  .. image:: /auto_examples/zapline/images/thumb/sphx_glr_plot_01_basic_usage_thumb.png
    :alt:

  :doc:`/auto_examples/zapline/plot_01_basic_usage`

.. raw:: html

      <div class="sphx-glr-thumbnail-title">ZapLine: Line Noise Removal Fundamentals.</div>
    </div>


.. raw:: html

    <div class="sphx-glr-thumbcontainer" tooltip="This tutorial demonstrates: 1. ZapLine with epoched MEG data (NoiseTools data3.mat) 2. High-channel MEG data (NoiseTools example_data.mat) 3. The sklearn-style Transformer API">

.. only:: html

  .. image:: /auto_examples/zapline/images/thumb/sphx_glr_plot_03_epoched_data_thumb.png
    :alt:

  :doc:`/auto_examples/zapline/plot_03_epoched_data`

.. raw:: html

      <div class="sphx-glr-thumbnail-title">ZapLine: Epoched Data and Real Data Examples.</div>
    </div>


.. raw:: html

    <div class="sphx-glr-thumbcontainer" tooltip="This tutorial covers: 1. Parameter exploration (n_remove, nkeep, threshold) 2. Real MEG data from NoiseTools 3. Comparing different parameter settings">

.. only:: html

  .. image:: /auto_examples/zapline/images/thumb/sphx_glr_plot_02_parameter_tuning_thumb.png
    :alt:

  :doc:`/auto_examples/zapline/plot_02_parameter_tuning`

.. raw:: html

      <div class="sphx-glr-thumbnail-title">ZapLine: Parameter Tuning and Real Data.</div>
    </div>


.. raw:: html

    <div class="sphx-glr-thumbcontainer" tooltip="This example replicates the core demonstrations from the Zapline-plus paper, showing the adaptive cleaning process on synthetic data.">

.. only:: html

  .. image:: /auto_examples/zapline/images/thumb/sphx_glr_plot_04_adaptive_mode_thumb.png
    :alt:

  :doc:`/auto_examples/zapline/plot_04_adaptive_mode`

.. raw:: html

      <div class="sphx-glr-thumbnail-title">ZapLine-plus: Paper-Faithful Example (Klug & Kloosterman 2022)</div>
    </div>


.. thumbnail-parent-div-close

.. raw:: html

    </div>


.. toctree::
   :hidden:

   /auto_examples/zapline/plot_05_adaptive_advanced
   /auto_examples/zapline/plot_01_basic_usage
   /auto_examples/zapline/plot_03_epoched_data
   /auto_examples/zapline/plot_02_parameter_tuning
   /auto_examples/zapline/plot_04_adaptive_mode

